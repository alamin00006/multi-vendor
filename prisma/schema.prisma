generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ===================== ENUMS ===================== */

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum UserRole {
  ADMIN
  USER
  MODERATOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum VendorStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum CouponType {
  PERCENTAGE
  FIXED
}

enum InventoryLogType {
  IN
  OUT
  ADJUSTMENT
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
}

/* ===================== USER ===================== */

model User {
  id              String     @id @default(uuid())
  firstName       String
  lastName        String
  email           String     @unique
  passwordHash    String
  phone           String?
  avatarUrl       String?
  role            UserRole   @default(USER)
  status          UserStatus @default(ACTIVE)
  lastLoginAt     DateTime?

  vendorsOwned    Vendor[]
  orders          Order[]
  reviews         Review[]
  wishlists       Wishlist[]
  carts           Cart[]
  couponUsages    CouponUsage[]
  payoutsRequested VendorPayout[]

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  deletedAt       DateTime?

  @@map("users")
}

/* ===================== VENDOR ===================== */

model Vendor {
  id            String        @id @default(uuid())
  name          String
  slug          String        @unique
  ownerId       String
  status        VendorStatus @default(PENDING)
  commissionPct Decimal       @db.Decimal(5,2)

  owner         User          @relation(fields: [ownerId], references: [id])
  products      Product[]
  vendorOrders  VendorOrder[]
  payouts       VendorPayout[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  @@map("vendors")
}

model VendorPayout {
  id            String       @id @default(uuid())
  vendorId      String
  requestedBy   String?
  amount        Decimal      @db.Decimal(10,2)
  netAmount     Decimal      @db.Decimal(10,2)
  method        String
  status        PayoutStatus @default(PENDING)

  vendor        Vendor       @relation(fields: [vendorId], references: [id])
  requestedUser User?        @relation(fields: [requestedBy], references: [id])

  createdAt     DateTime     @default(now())
  processedAt   DateTime?

  @@map("vendor_payouts")
}

/* ===================== CATALOG ===================== */

model Category {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  parentId  String?

  parent    Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryTree")
  products  Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

model Product {
  id              String   @id @default(uuid())
  vendorId        String
  name            String
  slug            String
  sku             String
  basePrice       Decimal  @db.Decimal(10,2)
  salePrice       Decimal? @db.Decimal(10,2)
  stockQuantity   Int      @default(0)
  categoryId      String
  isPublished     Boolean  @default(false)

  vendor          Vendor   @relation(fields: [vendorId], references: [id])
  category        Category @relation(fields: [categoryId], references: [id])
  variants        ProductVariant[]
  images          ProductImage[]
  inventories     Inventory[]
  orderItems      OrderItem[]
  reviews         Review[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  @@unique([vendorId, slug])
  @@unique([vendorId, sku])
  @@map("products")
}

model ProductVariant {
  id              String   @id @default(uuid())
  productId       String
  sku             String
  attributes      Json
  priceAdjustment Decimal  @db.Decimal(10,2)
  stockQuantity   Int      @default(0)

  product         Product @relation(fields: [productId], references: [id])
  orderItems      OrderItem[]
  inventories     Inventory[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([productId, sku])
  @@map("product_variants")
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  imageUrl  String
  isPrimary Boolean  @default(false)

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

/* ===================== CART ===================== */

model Cart {
  id        String     @id @default(uuid())
  userId    String?
  items     CartItem[]

  user      User?      @relation(fields: [userId], references: [id])

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid())
  cartId   String
  productId String
  variantId String?
  quantity Int
  unitPrice Decimal @db.Decimal(10,2)

  cart     Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product  Product @relation(fields: [productId], references: [id])
  variant  ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([cartId, productId, variantId])
  @@map("cart_items")
}

/* ===================== ORDER ===================== */

model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique
  userId          String
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)

  subtotalAmount  Decimal       @db.Decimal(10,2)
  totalAmount     Decimal       @db.Decimal(10,2)
  currency        String        @default("USD")

  user            User          @relation(fields: [userId], references: [id])
  items           OrderItem[]
  vendorOrders    VendorOrder[]
  payments        Payment[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("orders")
}

model VendorOrder {
  id                String      @id @default(uuid())
  vendorId          String
  orderId           String
  subtotal          Decimal     @db.Decimal(10,2)
  commissionRate    Decimal     @db.Decimal(5,2)
  commissionAmount  Decimal     @db.Decimal(10,2)
  vendorEarnings    Decimal     @db.Decimal(10,2)
  status            OrderStatus @default(PENDING)

  vendor            Vendor     @relation(fields: [vendorId], references: [id])
  order             Order      @relation(fields: [orderId], references: [id])
  items             OrderItem[]

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@map("vendor_orders")
}

model OrderItem {
  id                String   @id @default(uuid())
  orderId           String
  vendorOrderId     String
  vendorId          String
  productId         String
  variantId         String?
  quantity          Int
  unitPrice         Decimal  @db.Decimal(10,2)
  totalPrice        Decimal  @db.Decimal(10,2)
  commissionRate    Decimal  @db.Decimal(5,2)
  commissionAmount  Decimal  @db.Decimal(10,2)
  vendorEarnings    Decimal  @db.Decimal(10,2)

  order             Order     @relation(fields: [orderId], references: [id])
  vendorOrder       VendorOrder @relation(fields: [vendorOrderId], references: [id])
  vendor            Vendor    @relation(fields: [vendorId], references: [id])
  product           Product   @relation(fields: [productId], references: [id])
  variant           ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

/* ===================== PAYMENT ===================== */

model Payment {
  id          String        @id @default(uuid())
  orderId     String
  amount      Decimal       @db.Decimal(10,2)
  currency    String        @default("USD")
  status      PaymentStatus
  gatewayData Json?

  order       Order         @relation(fields: [orderId], references: [id])

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("payments")
}

/* ===================== INVENTORY ===================== */

model Inventory {
  id            String   @id @default(uuid())
  productId     String
  variantId     String?
  stockQuantity Int
  reservedQty   Int      @default(0)

  product       Product @relation(fields: [productId], references: [id])
  variant       ProductVariant? @relation(fields: [variantId], references: [id])
  logs          InventoryLog[]

  @@unique([productId, variantId])
  @@map("inventories")
}

model InventoryLog {
  id          String           @id @default(uuid())
  inventoryId String
  type        InventoryLogType
  quantity    Int
  note        String?

  inventory   Inventory        @relation(fields: [inventoryId], references: [id])

  createdAt   DateTime         @default(now())

  @@map("inventory_logs")
}

/* ===================== REVIEW / WISHLIST ===================== */

model Review {
  id        String   @id @default(uuid())
  userId    String
  productId String
  orderId   String?
  rating    Int
  comment   String?

  user      User    @relation(fields: [userId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
  order     Order?  @relation(fields: [orderId], references: [id])

  @@unique([userId, productId, orderId])
  @@map("reviews")
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String
  productId String

  user      User    @relation(fields: [userId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
  @@map("wishlists")
}

/* ===================== COUPON ===================== */

model Coupon {
  id        String      @id @default(uuid())
  code      String      @unique
  type      CouponType
  value     Decimal     @db.Decimal(10,2)
  isActive  Boolean     @default(true)

  usages    CouponUsage[]

  @@map("coupons")
}

model CouponUsage {
  id        String   @id @default(uuid())
  couponId  String
  orderId   String
  userId    String
  discount  Decimal  @db.Decimal(10,2)

  coupon    Coupon   @relation(fields: [couponId], references: [id])
  order     Order    @relation(fields: [orderId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([couponId, orderId])
  @@map("coupon_usages")
}
